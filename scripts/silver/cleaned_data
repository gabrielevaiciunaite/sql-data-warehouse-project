--crm_cust_info table
DO $$
BEGIN
  RAISE NOTICE '>> Truncating Table: silver.crm_cust_info';
  TRUNCATE TABLE silver.crm_cust_info;

  RAISE NOTICE '>> Inserting Data Into: silver.crm_cust_info';
INSERT INTO silver.crm_cust_info (
  cst_id,
  cst_key,
  cst_firstname,
  cst_lastname,
  cst_marital_status,
  cst_gndr,
  cst_create_date
)
SELECT
  cst_id,
  cst_key,
  TRIM(cst_firstname) AS cst_firstname,
  TRIM(cst_lastname) AS cst_lastname,
  CASE
    WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'
    WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'
    ELSE 'n/a'
  END AS cst_marital_status,
  CASE
    WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'Female'
    WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male'
    ELSE 'n/a'
  END AS cst_gndr,
  cst_create_date
FROM (
SELECT
		*,
				ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS flag_last
			FROM bronze.crm_cust_info
			WHERE cst_id IS NOT NULL
			) AS t
WHERE flag_last = 1;
RAISE NOTICE '>> Done. Rows inserted: %', (SELECT COUNT(*) FROM silver.crm_cust_info);
END $$;

--crm_prd_info

silver.crm_prd_info

--crm_sales_details

silver.crm_sales_details

--erp_cust_az12 table

DO $$
BEGIN
  RAISE NOTICE '>> Truncating Table: silver.erp_cust_az12';
  TRUNCATE TABLE silver.erp_cust_az12;

  RAISE NOTICE '>> Inserting Data Into: silver.erp_cust_az12';
INSERT INTO silver.erp_cust_az12 (
			cid,
			bdate,
			gen
		)
SELECT
			CASE
				WHEN cid LIKE 'NAS%' THEN SUBSTRING(cid, 4, LENGTH(cid))
				ELSE cid
			END AS cid, 
			CASE
				WHEN bdate > now() THEN NULL
				ELSE bdate
			END AS bdate,
			CASE
				WHEN UPPER(TRIM(gen)) IN ('F', 'FEMALE') THEN 'Female'
				WHEN UPPER(TRIM(gen)) IN ('M', 'MALE') THEN 'Male'
				ELSE 'n/a'
			END AS gen 
		FROM bronze.erp_cust_az12;

RAISE NOTICE '>> Done. Rows inserted: %', (SELECT COUNT(*) FROM silver.erp_cust_az12);
END $$;

--erp_loc_a101 table

DO $$
BEGIN
  RAISE NOTICE '>> Truncating Table: silver.erp_loc_a101';
  TRUNCATE TABLE silver.erp_loc_a101;

  RAISE NOTICE '>> Inserting Data Into: silver.erp_loc_a101';
INSERT INTO silver.erp_loc_a101 (
			cid,
			cntry
		)
		SELECT
			REPLACE(cid, '-', '') AS cid, 
			CASE
				WHEN TRIM(cntry) = 'DE' THEN 'Germany'
				WHEN TRIM(cntry) IN ('US', 'USA') THEN 'United States'
				WHEN TRIM(cntry) = '' OR cntry IS NULL THEN 'n/a'
				ELSE TRIM(cntry)
			END AS cntry 
		FROM bronze.erp_loc_a101;

RAISE NOTICE '>> Done. Rows inserted: %', (SELECT COUNT(*) FROM silver.erp_loc_a101);
END $$;

